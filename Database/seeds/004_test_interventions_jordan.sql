/**
 * SEED INTERVENTIONS DE TEST POUR JORDAN
 *
 * Ce script cr√©e des interventions de test pour Jordan (ScheduleEvent dans EBP)
 * afin de tester le workflow complet de l'application mobile.
 *
 * ‚úÖ CE QUE CE SCRIPT FAIT :
 * - Cr√©e 5 interventions de test avec diff√©rents statuts
 * - PENDING (1) : Pour tester le d√©marrage
 * - IN_PROGRESS (1) : Pour tester le TimeSheet et la cl√¥ture
 * - SCHEDULED (2) : Interventions futures
 * - COMPLETED (1) : Intervention termin√©e
 *
 * üéØ STATUTS EBP EventState :
 * - 0 = Scheduled/Planifi√©
 * - 1 = In Progress/Confirm√©
 * - 2 = Completed/Termin√©
 * - 3 = Cancelled/Annul√©
 * - 4 = Pending/En attente
 *
 * Auteur: Claude Code
 * Date: 2025-10-26
 */

-- ============================================================================
-- V√âRIFICATION PR√âALABLE
-- ============================================================================

DO $$
DECLARE
    v_jordan_colleague_exists BOOLEAN;
    v_customer_count INTEGER;
BEGIN
    -- V√©rifier que le Colleague Jordan existe
    SELECT EXISTS(
        SELECT 1 FROM public."Colleague" WHERE "Id" = 'JORDAN'
    ) INTO v_jordan_colleague_exists;

    IF NOT v_jordan_colleague_exists THEN
        RAISE EXCEPTION 'ERREUR: Le Colleague JORDAN n''existe pas dans public."Colleague" !';
    END IF;

    -- V√©rifier qu'il y a des clients
    SELECT COUNT(*) INTO v_customer_count FROM public."Customer" WHERE "ActiveState" = 1;

    IF v_customer_count = 0 THEN
        RAISE WARNING '‚ö†Ô∏è  Aucun client actif trouv√©. Les interventions auront un CustomerId NULL';
    ELSE
        RAISE NOTICE '‚úÖ % client(s) actif(s) trouv√©(s)', v_customer_count;
    END IF;

    RAISE NOTICE '‚úÖ Pr√™t √† cr√©er les interventions de test pour Jordan';
END $$;

-- ============================================================================
-- FONCTION HELPER POUR TROUVER UN CLIENT
-- ============================================================================

CREATE OR REPLACE FUNCTION get_random_customer_id()
RETURNS VARCHAR(20) AS $$
DECLARE
    v_customer_id VARCHAR(20);
BEGIN
    SELECT "Id" INTO v_customer_id
    FROM public."Customer"
    WHERE "ActiveState" = 1
    ORDER BY RANDOM()
    LIMIT 1;

    RETURN v_customer_id;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- CR√âATION DES INTERVENTIONS DE TEST
-- ============================================================================

DO $$
DECLARE
    v_jordan_id VARCHAR(20) := 'JORDAN';
    v_customer_id VARCHAR(20);
    v_intervention_id UUID;
    v_schedule_number VARCHAR(50);
BEGIN
    -- R√©cup√©rer un client al√©atoire
    v_customer_id := get_random_customer_id();

    RAISE NOTICE '';
    RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    RAISE NOTICE '    CR√âATION DES INTERVENTIONS DE TEST POUR JORDAN';
    RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    RAISE NOTICE '';

    -- ========================================================================
    -- INTERVENTION 1: PENDING (En attente)
    -- ========================================================================
    v_intervention_id := gen_random_uuid();
    v_schedule_number := 'INT-TEST-001';

    IF NOT EXISTS (SELECT 1 FROM public."ScheduleEvent" WHERE "ScheduleEventNumber" = v_schedule_number) THEN
        INSERT INTO public."ScheduleEvent" (
            "Id",
            "ScheduleEventNumber",
            "Caption",
            "NotesClear",
            "Maintenance_InterventionDescriptionClear",
            "ColleagueId",
            "CustomerId",
            "StartDateTime",
            "EndDateTime",
            "EventState",
            "EventType",
            "ExpectedDuration_DurationInHours",
            "AchievedDuration_DurationInHours",
            "Address_Address1",
            "Address_City",
            "Address_ZipCode",
            "Address_Latitude",
            "Address_Longitude",
            "sysCreatedDate",
            "sysModifiedDate",
            "ActiveState"
        ) VALUES (
            v_intervention_id,
            v_schedule_number,
            'Test Intervention PENDING - Maintenance climatisation',
            'Intervention de test en attente de d√©marrage',
            'Contr√¥le annuel et nettoyage filtres climatisation bureau',
            v_jordan_id,
            v_customer_id,
            NOW() + INTERVAL '2 hours', -- Dans 2 heures
            NOW() + INTERVAL '5 hours',
            4, -- PENDING
            1, -- Maintenance
            3.0, -- 3 heures estim√©es
            0.0, -- Pas encore commenc√©
            '15 Rue de la R√©publique',
            'Lyon',
            '69002',
            45.7597, -- Lyon
            4.8422,
            NOW(),
            NOW(),
            1 -- Actif
        );

        RAISE NOTICE '‚úÖ Intervention 1 cr√©√©e: % (PENDING)', v_schedule_number;
    ELSE
        RAISE NOTICE '‚ö†Ô∏è  Intervention 1 existe d√©j√†: %', v_schedule_number;
    END IF;

    -- ========================================================================
    -- INTERVENTION 2: IN_PROGRESS (En cours)
    -- ========================================================================
    v_intervention_id := gen_random_uuid();
    v_schedule_number := 'INT-TEST-002';

    IF NOT EXISTS (SELECT 1 FROM public."ScheduleEvent" WHERE "ScheduleEventNumber" = v_schedule_number) THEN
        INSERT INTO public."ScheduleEvent" (
            "Id",
            "ScheduleEventNumber",
            "Caption",
            "NotesClear",
            "Maintenance_InterventionDescriptionClear",
            "ColleagueId",
            "CustomerId",
            "StartDateTime",
            "EndDateTime",
            "EventState",
            "EventType",
            "ExpectedDuration_DurationInHours",
            "AchievedDuration_DurationInHours",
            "Address_Address1",
            "Address_City",
            "Address_ZipCode",
            "Address_Latitude",
            "Address_Longitude",
            "sysCreatedDate",
            "sysModifiedDate",
            "ActiveState",
            "ActualStartDate"
        ) VALUES (
            v_intervention_id,
            v_schedule_number,
            'Test Intervention IN_PROGRESS - R√©paration urgente',
            'Intervention en cours - TimeSheet √† tester',
            'R√©paration syst√®me √©lectrique suite panne',
            v_jordan_id,
            v_customer_id,
            NOW() - INTERVAL '1 hour', -- Commenc√© il y a 1h
            NOW() + INTERVAL '2 hours',
            1, -- IN_PROGRESS
            3, -- Repair
            2.5, -- 2.5 heures estim√©es
            1.0, -- 1 heure d√©j√† pass√©e
            '22 Avenue des Champs',
            'Paris',
            '75008',
            48.8698,
            2.3078,
            NOW() - INTERVAL '2 hours',
            NOW(),
            1, -- Actif
            NOW() - INTERVAL '1 hour'
        );

        RAISE NOTICE '‚úÖ Intervention 2 cr√©√©e: % (IN_PROGRESS)', v_schedule_number;
    ELSE
        RAISE NOTICE '‚ö†Ô∏è  Intervention 2 existe d√©j√†: %', v_schedule_number;
    END IF;

    -- ========================================================================
    -- INTERVENTION 3: SCHEDULED (Planifi√©e demain matin)
    -- ========================================================================
    v_intervention_id := gen_random_uuid();
    v_schedule_number := 'INT-TEST-003';

    IF NOT EXISTS (SELECT 1 FROM public."ScheduleEvent" WHERE "ScheduleEventNumber" = v_schedule_number) THEN
        INSERT INTO public."ScheduleEvent" (
            "Id",
            "ScheduleEventNumber",
            "Caption",
            "NotesClear",
            "Maintenance_InterventionDescriptionClear",
            "ColleagueId",
            "CustomerId",
            "StartDateTime",
            "EndDateTime",
            "EventState",
            "EventType",
            "ExpectedDuration_DurationInHours",
            "AchievedDuration_DurationInHours",
            "Address_Address1",
            "Address_City",
            "Address_ZipCode",
            "Address_Latitude",
            "Address_Longitude",
            "sysCreatedDate",
            "sysModifiedDate",
            "ActiveState"
        ) VALUES (
            v_intervention_id,
            v_schedule_number,
            'Test Intervention SCHEDULED - Installation',
            'Installation planifi√©e pour demain matin',
            'Installation nouveau syst√®me de s√©curit√©',
            v_jordan_id,
            v_customer_id,
            NOW() + INTERVAL '1 day' + INTERVAL '9 hours', -- Demain 9h
            NOW() + INTERVAL '1 day' + INTERVAL '13 hours',
            0, -- SCHEDULED
            1, -- Installation
            4.0, -- 4 heures estim√©es
            0.0,
            '8 Boulevard Haussmann',
            'Marseille',
            '13001',
            43.2965,
            5.3698,
            NOW(),
            NOW(),
            1 -- Actif
        );

        RAISE NOTICE '‚úÖ Intervention 3 cr√©√©e: % (SCHEDULED)', v_schedule_number;
    ELSE
        RAISE NOTICE '‚ö†Ô∏è  Intervention 3 existe d√©j√†: %', v_schedule_number;
    END IF;

    -- ========================================================================
    -- INTERVENTION 4: SCHEDULED (Planifi√©e apr√®s-demain)
    -- ========================================================================
    v_intervention_id := gen_random_uuid();
    v_schedule_number := 'INT-TEST-004';

    IF NOT EXISTS (SELECT 1 FROM public."ScheduleEvent" WHERE "ScheduleEventNumber" = v_schedule_number) THEN
        INSERT INTO public."ScheduleEvent" (
            "Id",
            "ScheduleEventNumber",
            "Caption",
            "NotesClear",
            "Maintenance_InterventionDescriptionClear",
            "ColleagueId",
            "CustomerId",
            "StartDateTime",
            "EndDateTime",
            "EventState",
            "EventType",
            "ExpectedDuration_DurationInHours",
            "AchievedDuration_DurationInHours",
            "Address_Address1",
            "Address_City",
            "Address_ZipCode",
            "Address_Latitude",
            "Address_Longitude",
            "sysCreatedDate",
            "sysModifiedDate",
            "ActiveState"
        ) VALUES (
            v_intervention_id,
            v_schedule_number,
            'Test Intervention SCHEDULED - Formation',
            'Formation utilisateurs planifi√©e',
            'Formation √©quipe sur nouveau syst√®me',
            v_jordan_id,
            v_customer_id,
            NOW() + INTERVAL '2 days' + INTERVAL '14 hours', -- Apr√®s-demain 14h
            NOW() + INTERVAL '2 days' + INTERVAL '17 hours',
            0, -- SCHEDULED
            5, -- Training
            3.0, -- 3 heures estim√©es
            0.0,
            '45 Rue du Commerce',
            'Toulouse',
            '31000',
            43.6047,
            1.4442,
            NOW(),
            NOW(),
            1 -- Actif
        );

        RAISE NOTICE '‚úÖ Intervention 4 cr√©√©e: % (SCHEDULED)', v_schedule_number;
    ELSE
        RAISE NOTICE '‚ö†Ô∏è  Intervention 4 existe d√©j√†: %', v_schedule_number;
    END IF;

    -- ========================================================================
    -- INTERVENTION 5: COMPLETED (Termin√©e hier)
    -- ========================================================================
    v_intervention_id := gen_random_uuid();
    v_schedule_number := 'INT-TEST-005';

    IF NOT EXISTS (SELECT 1 FROM public."ScheduleEvent" WHERE "ScheduleEventNumber" = v_schedule_number) THEN
        INSERT INTO public."ScheduleEvent" (
            "Id",
            "ScheduleEventNumber",
            "Caption",
            "NotesClear",
            "Maintenance_InterventionDescriptionClear",
            "Maintenance_InterventionReport",
            "ColleagueId",
            "CustomerId",
            "StartDateTime",
            "EndDateTime",
            "EventState",
            "EventType",
            "ExpectedDuration_DurationInHours",
            "AchievedDuration_DurationInHours",
            "Address_Address1",
            "Address_City",
            "Address_ZipCode",
            "Address_Latitude",
            "Address_Longitude",
            "sysCreatedDate",
            "sysModifiedDate",
            "ActiveState",
            "ActualStartDate",
            "EndDate"
        ) VALUES (
            v_intervention_id,
            v_schedule_number,
            'Test Intervention COMPLETED - Maintenance routini√®re',
            'Intervention termin√©e avec succ√®s',
            'Maintenance pr√©ventive mensuelle',
            'Contr√¥le effectu√©. Tous les syst√®mes fonctionnent correctement. Prochaine maintenance dans 1 mois.',
            v_jordan_id,
            v_customer_id,
            NOW() - INTERVAL '1 day' - INTERVAL '5 hours', -- Hier
            NOW() - INTERVAL '1 day' - INTERVAL '2 hours',
            2, -- COMPLETED
            2, -- Maintenance
            3.0, -- 3 heures estim√©es
            2.75, -- 2h45 r√©elles (9900 secondes)
            '12 Place Bellecour',
            'Lyon',
            '69002',
            45.7578,
            4.8320,
            NOW() - INTERVAL '2 days',
            NOW() - INTERVAL '1 day',
            1, -- Actif
            NOW() - INTERVAL '1 day' - INTERVAL '5 hours',
            NOW() - INTERVAL '1 day' - INTERVAL '2 hours'
        );

        RAISE NOTICE '‚úÖ Intervention 5 cr√©√©e: % (COMPLETED)', v_schedule_number;
    ELSE
        RAISE NOTICE '‚ö†Ô∏è  Intervention 5 existe d√©j√†: %', v_schedule_number;
    END IF;

    RAISE NOTICE '';
    RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    RAISE NOTICE '                  R√âSUM√â DES INTERVENTIONS';
    RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    RAISE NOTICE '';
    RAISE NOTICE 'üìã 5 interventions de test cr√©√©es pour Jordan:';
    RAISE NOTICE '';
    RAISE NOTICE '  1Ô∏è‚É£  INT-TEST-001: PENDING (dans 2h) - Climatisation Lyon';
    RAISE NOTICE '  2Ô∏è‚É£  INT-TEST-002: IN_PROGRESS (en cours) - R√©paration Paris';
    RAISE NOTICE '  3Ô∏è‚É£  INT-TEST-003: SCHEDULED (demain 9h) - Installation Marseille';
    RAISE NOTICE '  4Ô∏è‚É£  INT-TEST-004: SCHEDULED (apr√®s-demain 14h) - Formation Toulouse';
    RAISE NOTICE '  5Ô∏è‚É£  INT-TEST-005: COMPLETED (hier) - Maintenance Lyon';
    RAISE NOTICE '';
    RAISE NOTICE 'üéØ Tests possibles:';
    RAISE NOTICE '  ‚Ä¢ D√©marrer INT-TEST-001 (PENDING ‚Üí IN_PROGRESS)';
    RAISE NOTICE '  ‚Ä¢ TimeSheet sur INT-TEST-002 (d√©j√† 1h pass√©e)';
    RAISE NOTICE '  ‚Ä¢ Cl√¥turer INT-TEST-002 (IN_PROGRESS ‚Üí COMPLETED)';
    RAISE NOTICE '  ‚Ä¢ Voir les photos/signature de INT-TEST-005';
    RAISE NOTICE '  ‚Ä¢ Carte GPS avec toutes les interventions';
    RAISE NOTICE '';
    RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    RAISE NOTICE '';
END $$;

-- Cleanup de la fonction helper
DROP FUNCTION IF EXISTS get_random_customer_id();
